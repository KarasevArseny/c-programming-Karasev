CC = gcc
CFLAGS = -Wall -Wextra -std=c11
TARGET = todo
SRC = todo.c

# –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è SQLite —á–µ—Ä–µ–∑ pkg-config
SQLITE_CFLAGS = $(shell pkg-config --cflags sqlite3 2>/dev/null)
SQLITE_LIBS = $(shell pkg-config --libs sqlite3 2>/dev/null)

# Fallback, –µ—Å–ª–∏ pkg-config –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
ifeq ($(SQLITE_LIBS),)
    SQLITE_LIBS = -lsqlite3
endif

.PHONY: all clean run test examples info install-deps-linux install-deps-windows reset-db

all: $(TARGET)

$(TARGET): $(SRC)
	$(CC) $(CFLAGS) $(SQLITE_CFLAGS) $< $(SQLITE_LIBS) -o $@
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(TARGET)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config –∏ SQLite
check-pkg:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config ==="
	@if command -v pkg-config >/dev/null 2>&1; then \
		echo "‚úÖ pkg-config —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		echo "–§–ª–∞–≥–∏ SQLite:"; \
		pkg-config --cflags --libs sqlite3 || echo "‚ùå SQLite –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	else \
		echo "‚ùå pkg-config –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
info: check-pkg
	@echo ""
	@echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ ==="
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "–§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: $(CFLAGS) $(SQLITE_CFLAGS)"
	@echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: $(SQLITE_LIBS)"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:"
	@echo "  all          - —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  run          - –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  test         - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  examples     - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤"
	@echo "  clean        - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  reset-db     - —É–¥–∞–ª–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
	@echo "  install-deps-linux - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux"
	@echo "  install-deps-windows - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux
install-deps-linux:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux..."
	@sudo apt update
	@sudo apt install -y libsqlite3-dev pkg-config

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)
install-deps-windows:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)..."
	@pacman -S --noconfirm mingw-w64-ucrt-x86_64-sqlite3 mingw-w64-ucrt-x86_64-pkg-config

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "=== –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ==="
	@./$(TARGET)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: $(TARGET)
	@echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ TODO –º–µ–Ω–µ–¥–∂–µ—Ä–∞ ==="
	@echo ""
	@echo "1. –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞"
	@rm -f $(DB_FILE)
	@echo ""
	@echo "2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á"
	@./$(TARGET) add "–ò–∑—É—á–∏—Ç—å cJSON"
	@./$(TARGET) add "–ù–∞–ø–∏—Å–∞—Ç—å HTTP-–∫–ª–∏–µ–Ω—Ç"
	@./$(TARGET) add "–°–¥–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–±–æ—Ç—É"
	@echo ""
	@echo "3. –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏"
	@./$(TARGET) list all
	@echo ""
	@echo "4. –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É"
	@./$(TARGET) done 1
	@echo ""
	@echo "5. –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏"
	@./$(TARGET) list
	@echo ""
	@echo "6. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
	@./$(TARGET) stats
	@echo ""
	@echo "7. –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É 2"
	@./$(TARGET) delete 2
	@./$(TARGET) list all

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
examples: $(TARGET)
	@echo "=== –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ==="
	@echo ""
	@echo "1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á:"
	@./$(TARGET) add "–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç—á—ë—Ç"
	@./$(TARGET) add "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é"
	@./$(TARGET) add "–ü—Ä–æ–≤–µ—Å—Ç–∏ –≤—Å—Ç—Ä–µ—á—É"
	@echo ""
	@echo "2. –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–¥–∞—á:"
	@./$(TARGET) list all
	@echo ""
	@echo "3. –û—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏:"
	@./$(TARGET) done 1
	@./$(TARGET) list
	@echo ""
	@echo "4. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:"
	@./$(TARGET) stats
	@echo ""
	@echo "5. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏:"
	@./$(TARGET) delete 2
	@./$(TARGET) list all
	@echo ""
	@echo "6. –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á:"
	@./$(TARGET) clear
	@./$(TARGET) list all

# –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏
clean:
	rm -f $(TARGET) *.o
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—É–¥–∞–ª–µ–Ω–∏–µ todo.db)
reset-db:
	rm -f $(DB_FILE)
	@echo "üóëÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∞"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
distclean: clean reset-db

# –°–ø—Ä–∞–≤–∫–∞
help: info