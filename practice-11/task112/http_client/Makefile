CC = gcc
CFLAGS = -Wall -Wextra -std=c11
TARGET = http_client
SRC = http_client.c

# –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è libcurl —á–µ—Ä–µ–∑ pkg-config
CURL_CFLAGS = $(shell pkg-config --cflags libcurl 2>/dev/null)
CURL_LIBS = $(shell pkg-config --libs libcurl 2>/dev/null)

# Fallback, –µ—Å–ª–∏ pkg-config –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
ifeq ($(CURL_LIBS),)
    CURL_LIBS = -lcurl
endif

.PHONY: all clean run test examples info install-deps-linux install-deps-windows

all: $(TARGET)

$(TARGET): $(SRC)
	$(CC) $(CFLAGS) $(CURL_CFLAGS) $< $(CURL_LIBS) -o $@
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(TARGET)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config –∏ libcurl
check-pkg:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config ==="
	@if command -v pkg-config >/dev/null 2>&1; then \
		echo "‚úÖ pkg-config —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		echo "–§–ª–∞–≥–∏ libcurl:"; \
		pkg-config --cflags --libs libcurl || echo "‚ùå libcurl –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	else \
		echo "‚ùå pkg-config –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
info: check-pkg
	@echo ""
	@echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ ==="
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "–§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: $(CFLAGS) $(CURL_CFLAGS)"
	@echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: $(CURL_LIBS)"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:"
	@echo "  all          - —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  run          - –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  test         - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  examples     - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤"
	@echo "  clean        - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  install-deps-linux - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux"
	@echo "  install-deps-windows - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux
install-deps-linux:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux..."
	@sudo apt update
	@sudo apt install -y libcurl4-openssl-dev pkg-config

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)
install-deps-windows:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)..."
	@pacman -S --noconfirm mingw-w64-ucrt-x86_64-curl mingw-w64-ucrt-x86_64-pkg-config

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "=== –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ==="
	@./$(TARGET)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: $(TARGET)
	@echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP-–∫–ª–∏–µ–Ω—Ç–∞ ==="
	@echo ""
	@echo "1. GET –∑–∞–ø—Ä–æ—Å –∫ httpbin.org"
	@./$(TARGET) get https://httpbin.org/get > /tmp/test_output.txt
	@if grep -q "HTTP 200" /tmp/test_output.txt; then \
		echo "‚úÖ GET –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ GET –∑–∞–ø—Ä–æ—Å–∞"; \
	fi
	@echo ""
	@echo "2. GET –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º"
	@./$(TARGET) get https://httpbin.org/headers -H "User-Agent: TestClient/1.0" > /tmp/test_headers.txt
	@if grep -q "HTTP 200" /tmp/test_headers.txt; then \
		echo "‚úÖ GET —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ GET —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º"; \
	fi
	@echo ""
	@echo "3. GET –∑–∞–ø—Ä–æ—Å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ —Ñ–∞–π–ª"
	@./$(TARGET) get https://httpbin.org/json -o /tmp/response.json
	@if [ -f /tmp/response.json ]; then \
		echo "‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: /tmp/response.json"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞"; \
	fi
	@echo ""
	@echo "4. POST –∑–∞–ø—Ä–æ—Å —Å JSON"
	@./$(TARGET) post https://httpbin.org/post '{"test":"data"}' > /tmp/post_output.txt
	@if grep -q "HTTP 200" /tmp/post_output.txt; then \
		echo "‚úÖ POST –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞"; \
	fi
	@rm -f /tmp/test_output.txt /tmp/test_headers.txt /tmp/response.json /tmp/post_output.txt

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
examples: $(TARGET)
	@echo "=== –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ==="
	@echo ""
	@echo "1. –ü—Ä–æ—Å—Ç–æ–π GET –∑–∞–ø—Ä–æ—Å:"
	@./$(TARGET) get https://httpbin.org/get
	@echo ""
	@echo "2. GET –∑–∞–ø—Ä–æ—Å —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º:"
	@./$(TARGET) get https://httpbin.org/headers -H "User-Agent: MyClient/1.0"
	@echo ""
	@echo "3. GET –∑–∞–ø—Ä–æ—Å —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ —Ñ–∞–π–ª:"
	@./$(TARGET) get https://httpbin.org/json -o response.json
	@ls -la response.json
	@echo ""
	@echo "4. POST –∑–∞–ø—Ä–æ—Å —Å JSON:"
	@./$(TARGET) post https://httpbin.org/post '{"name":"Alice","age":25}'
	@rm -f response.json

# –û—á–∏—Å—Ç–∫–∞
clean:
	rm -f $(TARGET) *.o response.json
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°–ø—Ä–∞–≤–∫–∞
help: info