CC = gcc
CFLAGS = -Wall -Wextra -std=c11 -Iinclude
LDFLAGS = 

SRC_DIR = src
OBJ_DIR = obj
BIN_DIR = bin
TARGET = $(BIN_DIR)/weather

SOURCES = $(wildcard $(SRC_DIR)/*.c)
OBJECTS = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(SOURCES))

# –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –±–∏–±–ª–∏–æ—Ç–µ–∫ —á–µ—Ä–µ–∑ pkg-config
CJSON_CFLAGS = $(shell pkg-config --cflags libcjson 2>/dev/null)
CJSON_LIBS = $(shell pkg-config --libs libcjson 2>/dev/null)
CURL_CFLAGS = $(shell pkg-config --cflags libcurl 2>/dev/null)
CURL_LIBS = $(shell pkg-config --libs libcurl 2>/dev/null)
SQLITE_CFLAGS = $(shell pkg-config --cflags sqlite3 2>/dev/null)
SQLITE_LIBS = $(shell pkg-config --libs sqlite3 2>/dev/null)

# Fallback, –µ—Å–ª–∏ pkg-config –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
ifeq ($(CJSON_LIBS),)
    CJSON_LIBS = -lcjson
endif
ifeq ($(CURL_LIBS),)
    CURL_LIBS = -lcurl
endif
ifeq ($(SQLITE_LIBS),)
    SQLITE_LIBS = -lsqlite3
endif

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ñ–ª–∞–≥–∏
ALL_CFLAGS = $(CFLAGS) $(CJSON_CFLAGS) $(CURL_CFLAGS) $(SQLITE_CFLAGS)
ALL_LIBS = $(CJSON_LIBS) $(CURL_LIBS) $(SQLITE_LIBS) $(LDFLAGS)

.PHONY: all clean run test examples info install-deps-linux install-deps-windows reset-db dirs

all: dirs $(TARGET)

dirs:
	mkdir -p $(OBJ_DIR) $(BIN_DIR)

$(TARGET): $(OBJECTS)
	$(CC) $^ $(ALL_LIBS) -o $@
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(TARGET)"

$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) $(ALL_CFLAGS) -c $< -o $@

# –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
check-pkg:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config ==="
	@if command -v pkg-config >/dev/null 2>&1; then \
		echo "‚úÖ pkg-config —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		echo ""; \
		echo "cJSON:"; \
		pkg-config --cflags --libs libcjson || echo "‚ùå cJSON –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
		echo ""; \
		echo "libcurl:"; \
		pkg-config --cflags --libs libcurl || echo "‚ùå libcurl –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
		echo ""; \
		echo "SQLite:"; \
		pkg-config --cflags --libs sqlite3 || echo "‚ùå SQLite –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	else \
		echo "‚ùå pkg-config –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
info: check-pkg
	@echo ""
	@echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ ==="
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "–§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: $(ALL_CFLAGS)"
	@echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: $(ALL_LIBS)"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:"
	@echo "  all          - —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  run          - –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  test         - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  examples     - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤"
	@echo "  clean        - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  reset-db     - —É–¥–∞–ª–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
	@echo "  install-deps-linux - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux"
	@echo "  install-deps-windows - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux
install-deps-linux:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux..."
	@sudo apt update
	@sudo apt install -y libcjson-dev libcurl4-openssl-dev libsqlite3-dev pkg-config

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)
install-deps-windows:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)..."
	@pacman -S --noconfirm mingw-w64-ucrt-x86_64-cjson mingw-w64-ucrt-x86_64-curl mingw-w64-ucrt-x86_64-sqlite3 mingw-w64-ucrt-x86_64-pkg-config

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "=== –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ==="
	@./$(TARGET)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: $(TARGET)
	@echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã ==="
	@echo ""
	@echo "1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã –¥–ª—è –ú–æ—Å–∫–≤—ã"
	@./$(TARGET) fetch Moscow
	@echo ""
	@echo "2. –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
	@./$(TARGET) history
	@echo ""
	@echo "3. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å"
	@./$(TARGET) last

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
examples: $(TARGET)
	@echo "=== –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ==="
	@echo ""
	@echo "1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤:"
	@./$(TARGET) fetch Moscow
	@./$(TARGET) fetch "Saint Petersburg"
	@./$(TARGET) fetch London
	@echo ""
	@echo "2. –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:"
	@./$(TARGET) history
	@echo ""
	@echo "3. –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å:"
	@./$(TARGET) last
	@echo ""
	@echo "4. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π:"
	@./$(TARGET) cleanup 7

# –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏
clean:
	rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
reset-db:
	rm -f $(DB_FILE) weather.db
	@echo "üóëÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª–µ–Ω–∞"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
distclean: clean reset-db

# –°–ø—Ä–∞–≤–∫–∞
help: info