CC = gcc
CFLAGS = -Wall -Wextra -std=c11
TARGET = config_manager
SRC = config_manager.c

# –ü–æ–ª—É—á–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è cJSON —á–µ—Ä–µ–∑ pkg-config
PKG_CONFIG = pkg-config
CJSON_CFLAGS = $(shell $(PKG_CONFIG) --cflags libcjson 2>/dev/null)
CJSON_LIBS = $(shell $(PKG_CONFIG) --libs libcjson 2>/dev/null)

# Fallback, –µ—Å–ª–∏ pkg-config –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
ifeq ($(CJSON_CFLAGS),)
    CJSON_CFLAGS = -I/usr/include/cjson
    CJSON_LIBS = -lcjson
endif

.PHONY: all clean install uninstall check-pkg help

all: $(TARGET)

$(TARGET): $(SRC)
	$(CC) $(CFLAGS) $(CJSON_CFLAGS) $< $(CJSON_LIBS) -o $@
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(TARGET)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config
check-pkg:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ pkg-config ==="
	@if command -v pkg-config >/dev/null 2>&1; then \
		echo "‚úÖ pkg-config —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
		echo "–§–ª–∞–≥–∏ cJSON:"; \
		pkg-config --cflags --libs libcjson || echo "‚ùå libcjson –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	else \
		echo "‚ùå pkg-config –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "=== –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ==="
	@./$(TARGET)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux
install-deps-linux:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux..."
	@sudo apt update
	@sudo apt install -y libcjson-dev pkg-config

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)
install-deps-windows:
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows (MSYS2)..."
	@pacman -S --noconfirm mingw-w64-ucrt-x86_64-cjson mingw-w64-ucrt-x86_64-pkg-config

# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
examples: $(TARGET)
	@echo "=== –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ==="
	@echo ""
	@echo "1. –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:"
	@./$(TARGET)
	@echo ""
	@echo "2. –ò–∑–º–µ–Ω–∏—Ç—å debug –Ω–∞ true:"
	@./$(TARGET) set debug true
	@./$(TARGET)
	@echo ""
	@echo "3. –ò–∑–º–µ–Ω–∏—Ç—å max_connections –Ω–∞ 200:"
	@./$(TARGET) set max_connections 200
	@./$(TARGET)
	@echo ""
	@echo "4. –ò–∑–º–µ–Ω–∏—Ç—å log_file:"
	@./$(TARGET) set log_file /tmp/app.log
	@./$(TARGET)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: $(TARGET)
	@echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã ==="
	@echo ""
	@echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
	@./$(TARGET) > /tmp/test_output.txt
	@if grep -q "debug: false" /tmp/test_output.txt; then \
		echo "‚úÖ –ü–æ–∫–∞–∑–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"; \
	else \
		echo "‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"; \
	fi
	@echo ""
	@echo "2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
	@./$(TARGET) set debug true
	@./$(TARGET) | grep -q "debug: true" && echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞" || echo "‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
	@./$(TARGET) set debug false
	@echo ""
	@echo "3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª"
	@./$(TARGET) set max_connections 150
	@./$(TARGET) | grep -q "max_connections: 150" && echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ" || echo "‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
	@./$(TARGET) set max_connections 100

# –û—á–∏—Å—Ç–∫–∞
clean:
	rm -f $(TARGET) *.o
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
info:
	@echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ ==="
	@echo "–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "–§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏: $(CFLAGS) $(CJSON_CFLAGS)"
	@echo "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: $(CJSON_LIBS)"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:"
	@echo "  all          - —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  run          - –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
	@echo "  check-pkg    - –ø—Ä–æ–≤–µ—Ä–∫–∞ pkg-config"
	@echo "  install-deps-linux - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Linux"
	@echo "  install-deps-windows - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è Windows"
	@echo "  examples     - –∑–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–æ–≤"
	@echo "  test         - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  clean        - –æ—á–∏—Å—Ç–∫–∞"
	@echo "  info         - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ"

help: info

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ config.json
reset-config:
	@echo '{"app_name":"MyApp","version":"1.0","settings":{"debug":false,"max_connections":100,"timeout_seconds":30,"log_file":"/var/log/myapp.log"},"allowed_hosts":["localhost","127.0.0.1"]}' > config.json
	@echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞"